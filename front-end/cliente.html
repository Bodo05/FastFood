<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cliente - Fast Food</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
<style>.card-small{width:180px;margin:8px}.nav-btn{margin-left:8px}</style>
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">FAST FOOD</a>
    <div class="d-flex ms-auto">
      <button class="btn btn-outline-light nav-btn" onclick="location.href='ricerca.html'">Ricerca</button>
      <button class="btn btn-outline-light nav-btn" onclick="location.href='gestioneCliente.html'">Gestione</button>
      <button class="btn btn-outline-light nav-btn" onclick="logout()">Logout</button>
    </div>
  </div>
</nav>

<div class="container mt-3">
  <h4>Le tue categorie preferite</h4>
  <div id="categorieContainer" class="d-flex flex-wrap"></div>

  <hr>
  <h4>Piatti (da ristoratori)</h4>
  <div id="piattiContainer" class="d-flex flex-wrap"></div>
</div>

<script>
// controlla sessione
const _id = localStorage.getItem("_id");
const userType = localStorage.getItem("userType");
if(!_id || userType !== 'cliente') { alert('Devi effettuare login'); location.href='login.html'; }

async function logout(){ localStorage.clear(); location.href='login.html'; }

// carica categorie preferite e mostra piatti rilevanti (semplice: mostra piatti di tutti ristoratori che match categoria)
async function loadClienteData(){
    try {
        const res = await fetch(`http://localhost:3000/cliente/${_id}`);
        if(!res.ok) throw new Error('Errore caricamento cliente');
        const cliente = await res.json();

        const categorie = cliente.preferenze || [];
        const contCat = document.getElementById('categorieContainer');
        contCat.innerHTML = "";
        if(categorie.length === 0) contCat.textContent = "Nessuna preferenza selezionata";
        else categorie.forEach(cat=>{
            const d=document.createElement('div'); d.className='card card-small text-center p-2';
            d.innerHTML = `<strong>${cat}</strong>`;
            d.onclick = ()=> searchByCategoria(cat);
            contCat.appendChild(d);
        });

        // mostra piatti da ristoratori filtrando per le preferenze (se presenti)
        const contPiatti = document.getElementById('piattiContainer');
        contPiatti.innerHTML = "";
        if(categorie.length === 0) {
            contPiatti.textContent = "Nessun piatto da mostrare — scegli preferenze.";
            return;
        }

        // Richiesta semplice: per ogni categoria prendiamo ristoratori con piatti di quella categoria
        // Chiameremo /search?categoria=...
        for (const cat of categorie) {
            const r = await fetch(`http://localhost:3000/search?categoria=${encodeURIComponent(cat)}`);
            if(!r.ok) continue;
            const list = await r.json();
            list.forEach(risto=>{
                // ogni risto.piatti può contenere oggetti
                (risto.piatti || []).filter(p => p.categoria === cat).forEach(p=>{
                    const c = document.createElement('div'); c.className='card card-small text-center';
                    c.innerHTML = `
                        <img src="${p.thumb || ''}" class="card-img-top" style="height:100px;object-fit:cover" alt="${p.nome}">
                        <div class="card-body p-2">
                          <div><strong>${p.nome}</strong></div>
                          <div>€${p.price ?? '—'}</div>
                          <div>${p.prepTime ?? '—'} min</div>
                          <div class="text-muted small">${risto.nomeRistorante}</div>
                        </div>`;
                    contPiatti.appendChild(c);
                });
            });
        }

    } catch (err) {
        console.error(err);
        alert('Errore caricamento dati cliente');
    }
}

function searchByCategoria(cat) {
    // reindirizza a pagina ricerca passando parametro ?categoria=...
    location.href = `ricerca.html?categoria=${encodeURIComponent(cat)}`;
}

loadClienteData();
</script>
</body>
</html>
