<!DOCTYPE html>
<html lang="it">
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Gestione Cliente</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"></head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container-fluid">
    <a class="navbar-brand" href="cliente.html">FAST FOOD</a>
    <div class="d-flex ms-auto">
      <button class="btn btn-outline-light me-2" onclick="location.href='ricerca.html'">Ricerca</button>
      <button class="btn btn-outline-light" onclick="logout()">Logout</button>
    </div>
  </div>
</nav>

<div class="container mt-3">
  <h4>Modifica dati e preferenze</h4>
  <div id="infoForm">
    <div class="mb-2"><label>Nome</label><input id="nome" class="form-control"></div>
    <div class="mb-2"><label>Cognome</label><input id="cognome" class="form-control"></div>
    <div class="mb-2"><label>Email</label><input id="email" class="form-control" disabled></div>

    <div class="mb-2"><label>Preferenze</label><div id="prefs"></div></div>

    <button class="btn btn-primary" onclick="aggiorna()">Salva</button>
    <button class="btn btn-danger ms-2" onclick="elimina()">Elimina account</button>
  </div>
</div>

<script>
const _id = localStorage.getItem('_id');
if(!_id) location.href='login.html';
function logout(){ localStorage.clear(); location.href='login.html'; }

const allCategorie = ["Pizza","Panini","Dolci","Bibite","Insalate","Sushi","Veg"]; // esempio

async function load() {
    try {
        const res = await fetch(`http://localhost:3000/cliente/${_id}`);
        if(!res.ok) throw new Error('no');
        const c = await res.json();
        document.getElementById('nome').value = c.nome || '';
        document.getElementById('cognome').value = c.cognome || '';
        document.getElementById('email').value = c.email || '';

        const prefs = c.preferenze || [];
        const container = document.getElementById('prefs');
        container.innerHTML = '';
        allCategorie.forEach(cat=>{
            const div = document.createElement('div'); div.className='form-check';
            const checked = prefs.includes(cat) ? 'checked' : '';
            div.innerHTML = `<input class="form-check-input" type="checkbox" id="pref_${cat}" value="${cat}" ${checked}>
                             <label class="form-check-label" for="pref_${cat}">${cat}</label>`;
            container.appendChild(div);
        });
    } catch (err) { console.error(err); alert('Errore caricamento'); }
}

async function aggiorna() {
    const nome = document.getElementById('nome').value;
    const cognome = document.getElementById('cognome').value;
    const preferenze = Array.from(document.querySelectorAll('#prefs input[type=checkbox]:checked')).map(i=>i.value);
    const res = await fetch(`http://localhost:3000/cliente/${_id}`, {
        method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ nome, cognome, preferenze })
    });
    if(res.ok){ alert('Aggiornato'); location.href='cliente.html'; }
    else alert('Errore aggiornamento');
}

async function elimina() {
    if(!confirm('Eliminare account?')) return;
    const res = await fetch(`http://localhost:3000/cliente/${_id}`, { method: 'DELETE' });
    if(res.ok) { alert('Eliminato'); localStorage.clear(); location.href='login.html'; }
    else alert('Errore eliminazione');
}

load();
</script>
</body>
</html>
